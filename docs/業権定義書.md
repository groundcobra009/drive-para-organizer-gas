# 業権定義書（業務権限定義書）

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 業権定義書（業務権限定義書） |
| プロジェクト名 | drive-para-organizer-gas |
| バージョン | 1.0.0 |
| 作成日 | 2024年 |
| 最終更新日 | 2024年 |
| 作成者 | - |
| 承認者 | - |

---

## 2. システム概要

### 2.1 システムの目的
Google DriveのMy Drive直下のファイルを整理するためのGoogle Apps Scriptツール。PARAメソッド（Projects / Areas / Resources / Archive）に基づいてファイルを分類・移動・リネームする機能を提供する。

### 2.2 主要機能
1. **ファイル一覧取得機能**
   - My Drive直下のファイルをスプレッドシートに展開
   - ファイル情報（名前、ID、種類、更新日時など）の表示

2. **ファイル移動機能**
   - スプレッドシート上でチェックボックスによる移動指示
   - PARA分類フォルダ（パラ、プロジェクト、エリア、リソース、アーカイブ）への一括移動

3. **ファイルリネーム機能**
   - スプレッドシートからファイル名の変更指示
   - 変更指示に基づく一括リネーム処理

4. **設定管理機能**
   - サイドバー/ダイアログUIによる設定管理
   - PARA分類フォルダIDの設定・保存

---

## 3. 権限の種類とスコープ

### 3.1 Google Apps Script実行権限

#### 3.1.1 必要なOAuth 2.0スコープ

| スコープ | 説明 | 用途 | 必須度 |
|---------|------|------|--------|
| `https://www.googleapis.com/auth/drive` | Google Driveへのフルアクセス | ファイル一覧取得、移動、リネーム | **必須** |
| `https://www.googleapis.com/auth/drive.file` | 作成したファイルへのアクセスのみ | 制限付きアクセス（非推奨） | 任意 |
| `https://www.googleapis.com/auth/spreadsheets` | Googleスプレッドシートへのアクセス | スプレッドシートへの読み書き | **必須** |
| `https://www.googleapis.com/auth/script.container.ui` | カスタムUI表示 | サイドバー/ダイアログ表示 | **必須** |

#### 3.1.2 権限の付与方法
1. **初回実行時の承認**
   - Google Apps Scriptエディタから実行
   - ブラウザでOAuth承認画面が表示される
   - ユーザーが権限を承認

2. **manifest.json（appsscript.json）での明示的指定**
   ```json
   {
     "oauthScopes": [
       "https://www.googleapis.com/auth/drive",
       "https://www.googleapis.com/auth/spreadsheets",
       "https://www.googleapis.com/auth/script.container.ui"
     ]
   }
   ```

### 3.2 Google Drive API権限

#### 3.2.1 必要な権限レベル

| 操作 | 必要な権限 | 説明 |
|------|-----------|------|
| ファイル一覧取得 | `drive.files.list` | My Drive直下のファイル一覧を取得 |
| ファイル移動 | `drive.files.update` | ファイルの親フォルダを変更 |
| ファイルリネーム | `drive.files.update` | ファイル名を変更 |
| フォルダ情報取得 | `drive.files.get` | フォルダIDからフォルダ情報を取得 |
| ファイル情報取得 | `drive.files.get` | ファイルの詳細情報を取得 |

#### 3.2.2 アクセス制限
- **対象範囲**: 実行ユーザーが所有するファイル・フォルダのみ
- **共有ファイル**: 実行ユーザーが編集権限を持つファイルのみ操作可能
- **組織ポリシー**: Google Workspaceの組織ポリシーに準拠

### 3.3 Google Sheets API権限

#### 3.3.1 必要な権限レベル

| 操作 | 必要な権限 | 説明 |
|------|-----------|------|
| スプレッドシート読み取り | `spreadsheets.values.get` | スプレッドシートのデータを読み取り |
| スプレッドシート書き込み | `spreadsheets.values.update` | スプレッドシートにデータを書き込み |
| スプレッドシート作成 | `spreadsheets.create` | 新しいスプレッドシートを作成（初回のみ） |
| セル書式設定 | `spreadsheets.batchUpdate` | チェックボックス、書式設定など |

---

## 4. 機能別権限要件

### 4.1 ファイル一覧取得機能

#### 4.1.1 実行権限
- **実行ユーザー**: スクリプトを実行するユーザー
- **必要スコープ**: `https://www.googleapis.com/auth/drive`
- **権限レベル**: 読み取り専用で可（`drive.readonly`でも動作可能）

#### 4.1.2 アクセス対象
- My Drive直下のファイル・フォルダ
- 実行ユーザーが所有するファイル
- 実行ユーザーが閲覧可能な共有ファイル

#### 4.1.3 制限事項
- 削除済みファイルは取得不可
- 共有ドライブのファイルは取得不可（設定により変更可能）

### 4.2 ファイル移動機能

#### 4.2.1 実行権限
- **実行ユーザー**: スクリプトを実行するユーザー
- **必要スコープ**: `https://www.googleapis.com/auth/drive`
- **権限レベル**: 読み書き必須

#### 4.2.2 移動先フォルダの権限要件
- 移動先フォルダ（パラ、プロジェクト、エリア、リソース、アーカイブ）への書き込み権限が必要
- フォルダIDが無効またはアクセス不可の場合はエラー

#### 4.2.3 移動対象ファイルの権限要件
- 実行ユーザーが編集権限を持つファイルのみ移動可能
- 読み取り専用の共有ファイルは移動不可

### 4.3 ファイルリネーム機能

#### 4.3.1 実行権限
- **実行ユーザー**: スクリプトを実行するユーザー
- **必要スコープ**: `https://www.googleapis.com/auth/drive`
- **権限レベル**: 読み書き必須

#### 4.3.2 リネーム対象ファイルの権限要件
- 実行ユーザーが編集権限を持つファイルのみリネーム可能
- 読み取り専用の共有ファイルはリネーム不可

### 4.4 設定管理機能

#### 4.4.1 実行権限
- **実行ユーザー**: スクリプトを実行するユーザー
- **必要スコープ**: 
  - `https://www.googleapis.com/auth/spreadsheets`（PropertiesService使用時は不要）
  - `https://www.googleapis.com/auth/script.container.ui`

#### 4.4.2 設定データの保存場所
- **PropertiesService**: スクリプトプロパティに保存（推奨）
- **スプレッドシート**: 専用シートに保存（代替案）

#### 4.4.3 設定アクセス権限
- 実行ユーザーのみが設定を変更可能
- 他のユーザーが同じスクリプトを実行しても、個別の設定が適用される

---

## 5. ユーザー権限レベル

### 5.1 権限レベル定義

| レベル | 名称 | 説明 | 可能な操作 |
|--------|------|------|-----------|
| Level 1 | **実行ユーザー** | スクリプトを実行するユーザー | すべての機能を使用可能 |
| Level 2 | **共有ユーザー** | スクリプトを共有されたユーザー | 各自のMy Driveに対して操作可能 |

### 5.2 権限の継承
- スクリプトの実行権限は、実行ユーザーのGoogleアカウント権限に基づく
- Google Workspace環境では、組織のポリシーが適用される

---

## 6. セキュリティポリシー

### 6.1 データアクセス制限

#### 6.1.1 アクセス範囲の制限
- **原則**: 実行ユーザーが所有・アクセス可能なファイルのみ操作
- **例外**: 共有ファイルで編集権限を持つもののみ操作可能

#### 6.1.2 データの外部送信
- **禁止**: ファイル内容を外部サービスに送信しない
- **許可**: ファイルメタデータ（名前、ID、更新日時など）のみスプレッドシートに記録

### 6.2 認証・認可

#### 6.2.1 OAuth 2.0認証
- Google Apps Scriptの標準OAuth 2.0フローを使用
- トークンの自動更新はGoogle Apps Scriptが管理

#### 6.2.2 権限の最小化
- 必要最小限のスコープのみを要求
- 読み取り専用で済む操作は読み取り権限のみ使用

### 6.3 エラーハンドリング

#### 6.3.1 権限エラーの処理
- 権限不足エラー（403）の適切なハンドリング
- ユーザーへの分かりやすいエラーメッセージ表示

#### 6.3.2 ログ記録
- 権限エラーはログに記録（実行ログ）
- 機密情報はログに含めない

---

## 7. 権限の検証とテスト

### 7.1 権限検証方法

#### 7.1.1 手動検証
1. Google Apps Scriptエディタでスクリプトを実行
2. OAuth承認画面で要求される権限を確認
3. 各機能を実行し、権限エラーが発生しないことを確認

#### 7.1.2 自動検証（推奨）
```javascript
// 権限チェック関数の例
function checkPermissions() {
  try {
    // Drive APIのアクセステスト
    DriveApp.getRootFolder();
    
    // Sheets APIのアクセステスト
    SpreadsheetApp.getActiveSpreadsheet();
    
    Logger.log('すべての権限が正常に付与されています');
    return true;
  } catch (e) {
    Logger.log('権限エラー: ' + e.toString());
    return false;
  }
}
```

### 7.2 テストシナリオ

#### 7.2.1 正常系テスト
- [ ] ファイル一覧取得が正常に動作する
- [ ] ファイル移動が正常に動作する
- [ ] ファイルリネームが正常に動作する
- [ ] 設定保存・読み込みが正常に動作する

#### 7.2.2 異常系テスト
- [ ] 権限不足時のエラーハンドリング
- [ ] 無効なフォルダID指定時のエラーハンドリング
- [ ] 読み取り専用ファイル操作時のエラーハンドリング
- [ ] ネットワークエラー時のリトライ処理

---

## 8. 権限の管理と運用

### 8.1 権限の付与手順

1. **初回セットアップ**
   ```
   1. Google Apps Scriptエディタを開く
   2. スクリプトを初回実行
   3. OAuth承認画面で「許可」をクリック
   4. 要求される権限を確認して承認
   ```

2. **権限の再付与**
   - 権限を取り消した場合、次回実行時に再承認が必要
   - スコープを追加した場合、再承認が必要

### 8.2 権限の取り消し

#### 8.2.1 ユーザー側での取り消し
- Googleアカウント設定 > セキュリティ > サードパーティによるアクセス
- 該当アプリの権限を取り消し可能

#### 8.2.2 組織側での取り消し
- Google Workspace管理者が組織全体の権限を管理可能

### 8.3 権限の監査

#### 8.3.1 監査項目
- 付与されているスコープの確認
- 実際に使用されているスコープの確認
- 不要な権限の削除

#### 8.3.2 監査頻度
- 定期的な監査（四半期ごと推奨）
- セキュリティインシデント発生時の即時監査

---

## 9. トラブルシューティング

### 9.1 よくある権限エラー

#### 9.1.1 エラー: "アクセスが拒否されました"
- **原因**: 必要なスコープが付与されていない
- **解決策**: OAuth承認を再実行

#### 9.1.2 エラー: "ファイルが見つかりません"
- **原因**: フォルダIDが無効、またはアクセス権限がない
- **解決策**: フォルダIDを確認し、アクセス権限を確認

#### 9.1.3 エラー: "権限が不足しています"
- **原因**: ファイルが読み取り専用、または編集権限がない
- **解決策**: ファイルの共有設定を確認

### 9.2 デバッグ方法

#### 9.2.1 実行ログの確認
- Google Apps Scriptエディタの「実行ログ」を確認
- エラーメッセージから権限問題を特定

#### 9.2.2 権限の確認方法
```javascript
// 現在の権限を確認
function checkCurrentPermissions() {
  try {
    var files = DriveApp.getFiles();
    Logger.log('Drive API権限: OK');
  } catch (e) {
    Logger.log('Drive API権限: NG - ' + e.toString());
  }
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    Logger.log('Sheets API権限: OK');
  } catch (e) {
    Logger.log('Sheets API権限: NG - ' + e.toString());
  }
}
```

---

## 10. 付録

### 10.1 参考資料
- [Google Apps Script 権限の概要](https://developers.google.com/apps-script/guides/services/authorization)
- [Google Drive API スコープ](https://developers.google.com/drive/api/guides/api-specific-auth)
- [Google Sheets API スコープ](https://developers.google.com/sheets/api/guides/authorizing)

### 10.2 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2024年 | 1.0.0 | 初版作成 | - |

### 10.3 承認欄

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| 作成者 | - | - | - |
| レビュー者 | - | - | - |
| 承認者 | - | - | - |

---

**文書終了**
